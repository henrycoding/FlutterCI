name: iOS Build WYS-USER

on:
  workflow_dispatch:
    inputs:
      bump_build:
        description: '是否自动增加 build 号'
        required: true
        type: boolean
        default: true

jobs:
  build:
    name: CI Build
    runs-on: macos-15

    steps:
## 
      - name: Select Xcode version
        run: "sudo xcode-select --switch /Applications/Xcode_16.3.app/Contents/Developer"

# 安装必要的依赖
      - name: Install python and codemagic tools
        uses: actions/setup-python@v2
        with:
          python-version: '3.8'          

      - name: Install python dependencies
        run:  python -m pip install codemagic-cli-tools

# 设置SSH KEY
      - name: Setup SSH
        run: |
          mkdir -p "$HOME/.ssh"
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 "$HOME/.ssh/id_rsa"
          ssh-keyscan codeup.aliyun.com >> "$HOME/.ssh/known_hosts"
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

# Clone Repo
      - name: Clone target repo
        run: git clone --recursive "$WYS_USER_URL" -b $WYS_USER_BRANCH
        env:
          WYS_USER_URL: ${{ secrets.WYS_USER_URL }}
          WYS_USER_BRANCH: ${{ secrets.WYS_USER_BRANCH }}

# 版本号自动+1
      - name: Bump build number & push
        if: ${{ github.event.inputs.bump_build == 'true' }}
        run: |
          cd $WORKDIR
          
          # 读取 pubspec.yaml version
          VERSION_LINE=$(grep '^version:' pubspec.yaml)
          
          # 提取 version 和 build
          VERSION_NAME=$(echo $VERSION_LINE | cut -d'+' -f1 | awk '{print $2}')
          BUILD_NUM=$(echo $VERSION_LINE | cut -d'+' -f2)
          
          # build +1
          NEW_BUILD_NUM=$((BUILD_NUM + 1))
          
          # 替换 pubspec.yaml
          sed -i "" "s/^version:.*/version: $VERSION_NAME+$NEW_BUILD_NUM/" pubspec.yaml
          echo "NEW_BUILD_NUM=$NEW_BUILD_NUM" >> $GITHUB_ENV
          
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add pubspec.yaml
          git commit -m "release: $VERSION_NAME+$NEW_BUILD_NUM"
          git push

# 安装Flutter

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version-file: wanyisheng/pubspec.yaml

      - run: flutter --version

# Build Flutter                        
      - name: Building IPA
        run: |
          cd wanyisheng/ios
          fastlane ios release_beta
        env:
          PUB_HOSTED_URL: https://pub.flutter-io.cn
          FLUTTER_STORAGE_BASE_URL: https://storage.flutter-io.cn
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          APP_STORE_KEY_ID: ${{ secrets.AUTH_KEY_ID }}
          APP_STORE_ISSUER_ID: ${{ secrets.ISSUER_ID }}
          APP_STORE_PRIVATE_KEY: ${{ secrets.AUTH_KEY_BASE64 }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

      # - name: Upload IPA Artifact
      #   if: always()
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: ios-app
      #     path: ytj/ios/Runner.ipa
