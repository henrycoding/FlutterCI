name: iOS starter workflow

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    name: CI Build
    runs-on: macos-15

    steps:

# 创建存储目录
      - name: Create Folder for certificates and profiles
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          mkdir -p ~/Library/MobileDevice/Certificates/
        
## 设置证书
      - name: Get Certificate
        id: certFileDecode
        uses: timheuer/base64-to-file@v1.0.3
        with:
          fileName: 'certificate.p12'
          encodedString: ${{ secrets.P12_BASE64 }}

      - name: Copy Certificate
        run: mv ${{ steps.certFileDecode.outputs.filePath }} ~/Library/MobileDevice/Certificates/certificate.p12
    
## 设置 APP MOBIPROVISION
      - name: Get Profile
        id: profFileDecodeApp
        uses: timheuer/base64-to-file@v1.0.3
        with:
          fileName: 'app.mobileprovision'
          encodedString: ${{ secrets.APP_MOBILEPROVISION_BASE64 }}

      - name: Copy Profiles
        run: mv ${{ steps.profFileDecodeApp.outputs.filePath }} ~/Library/MobileDevice/Provisioning\ Profiles/app.mobileprovision

## 设置 WIDGET MOBIPROVISION
      - name: Get Profile
        id: profFileDecodeWidget
        uses: timheuer/base64-to-file@v1.0.3
        with:
          fileName: 'widget.mobileprovision'
          encodedString: ${{ secrets.WIDGET_MOBILEPROVISION_BASE64 }}

      - name: Copy Profiles
        run: mv ${{ steps.profFileDecodeWidget.outputs.filePath }} ~/Library/MobileDevice/Provisioning\ Profiles/widget.mobileprovision


## 设置 Auth Key
      - name: Get Auth Key Profile
        id: authKey
        uses: timheuer/base64-to-file@v1.0.3
        with:
          fileName: 'AuthKey_${{ secrets.AUTH_KEY_ID }}.p8'
          encodedString: ${{ secrets.AUTH_KEY_BASE64 }}

      - name: Copy Profiles
        run: |
          mkdir -p ~/private_keys
          mv ${{ steps.authKey.outputs.filePath }} ~/private_keys



# 安装必要的依赖
      - name: Install python and codemagic tools
        uses: actions/setup-python@v2
        with:
          python-version: '3.8'          

      - name: Install python dependencies
        run:  python -m pip install codemagic-cli-tools

# 设置SSH KEY
      - name: Setup SSH
        run: |
          mkdir -p "$HOME/.ssh"
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 "$HOME/.ssh/id_rsa"
          ssh-keyscan codeup.aliyun.com >> "$HOME/.ssh/known_hosts"
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

# Clone Repo
      - name: Clone target repo
        run: git clone --recursive "$MAINURL" -b $BRANCH
        env:
          MAINURL: ${{ secrets.MAINURL }}
          BRANCH: ${{ secrets.BRANCH }}

# 安装Flutter

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version-file: ytj/pubspec.yaml

      - run: flutter --version

# Build Flutter
      - name: Building IPA
        run: |
          cd ytj
          xcode-project use-profiles
          flutter pub get
          find ~/.pub-cache -name "*.xcprivacy" -delete
          flutter build ipa --dart-define=git-branch=$(git rev-parse --abbrev-ref HEAD) --dart-define=git-commit=$(git rev-parse --short HEAD) --dart-define=app-channel=appstore --obfuscate --split-debug-info=symbols --release --no-codesign
        env:
          PUB_HOSTED_URL: https://pub.flutter-io.cn
          FLUTTER_STORAGE_BASE_URL: https://storage.flutter-io.cn


      - name: Building xcworkspace
        run: |
          xcode-project build-ipa --workspace ios/Runner.xcworkspace --scheme Runner --config Release
        env:
          PUB_HOSTED_URL: https://pub.flutter-io.cn
          FLUTTER_STORAGE_BASE_URL: https://storage.flutter-io.cn
